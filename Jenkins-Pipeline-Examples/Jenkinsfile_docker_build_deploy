pipeline {
    agent any

    options {
    // Keep the 1 most recent builds
    buildDiscarder(logRotator(numToKeepStr:'1'))
    }
    
    tools {
        maven "MAVEN_HOME"
    }

    stages{
        stage('Build Maven'){
            steps{
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/mmukul/simple-app-devopscicd-demo']]])
                sh 'mvn clean install'
            }
        }

        stage ('Unit Test') {
            steps {
                sh 'mvn test' 
            }
            post {
               success {
                    junit 'target/surefire-reports/**/*.xml'
                }   
            }
        }

        stage('Build & Push image to DockerHub'){
            steps{
                script{
                   withDockerRegistry(credentialsId: 'dockerhub-pwd', url: 'https://hub.docker.com/'){
                   sh 'docker build -t smilemukul/my-app-1.0:v1 .'
                   sh 'docker push'
                }
            }
        }
    }

        stage('Deploy in Container'){
            steps{
                script{
                    sh 'docker run smilemukul/my-app-1.0:v1'
                    echo 'Application is Successfully deployed in container'
                }
            }
        }

        stage('Cleanup'){
            steps{
                script{
                    sh 'docker rmi docker.io/openjdk:8 smilemukul/my-app-1.0:v1 -f'
                    echo 'Docker images are successfully removed from the local system'
                }
            }
        }
    }
}

        
